# ステップ0 実装とテストガイド

## 概要

このドキュメントは、配色カラープリセットTSVシステムの**ステップ0（準備段階）**の実装とテスト方法を詳細に説明します。

**ステップ0の目的**: 本番コードに一切影響を与えずに、TSVファイルと変換スクリプトを作成し、正常に動作することを確認する。

---

## 📋 実装内容

### 作成したファイル

1. **color_presets.tsv** - 全33色プリセットのマスターデータ
2. **color_preset_converter.py** - TSV → C++ヘッダー変換スクリプト

### 実装の詳細

#### 1. color_presets.tsv
- **行数**: 34行（ヘッダー1行 + データ33行）
- **列数**: 11列（id, name, name_en, color1-8）
- **データ量**: 33プリセット × 8色 = 264色
- **フォーマット**: TSV（タブ区切り）
- **エンコーディング**: UTF-8

**構造**:
```
id  name         name_en      color1         color2         ...  color8
1   レインボー    Rainbow      255,255,0,0    255,255,128,0  ...  255,255,0,255
...
33  モノクロ      Monochrome   255,255,255,255 ...           ...  255,0,0,0
```

#### 2. color_preset_converter.py
- **ベース**: color_preset_converter_POC.py
- **機能**:
  - TSVファイルのパース
  - データバリデーション（ARGB範囲0-255チェック）
  - C++コード生成
  - ヘッダーファイル出力

---

## 🧪 テスト手順

### テスト1: TSVファイルの検証

#### 目的
TSVファイルが正しいフォーマットで、全33プリセットのデータが含まれているか確認する。

#### 手順
```bash
cd /home/runner/work/Windy_Lines/Windy_Lines

# 1. ファイルが存在することを確認
ls -lh color_presets.tsv

# 2. 行数を確認（34行であるべき：ヘッダー1 + データ33）
wc -l color_presets.tsv
# 期待値: 34 color_presets.tsv

# 3. 列数を確認（11列であるべき）
head -1 color_presets.tsv | awk -F'\t' '{print NF}'
# 期待値: 11

# 4. ヘッダー行を確認
head -1 color_presets.tsv
# 期待値: id	name	name_en	color1	color2	color3	color4	color5	color6	color7	color8

# 5. 最初のプリセット（レインボー）を確認
head -2 color_presets.tsv | tail -1
# 期待値: 1	レインボー	Rainbow	255,255,0,0	...

# 6. 最後のプリセット（モノクロ）を確認
tail -1 color_presets.tsv
# 期待値: 33	モノクロ	Monochrome	255,255,255,255	...

# 7. 全プリセット名を確認
tail -n +2 color_presets.tsv | cut -f2
# 期待値: 33行のプリセット名リスト
```

#### 期待される結果
- ✅ ファイルサイズ: 約2-3KB
- ✅ 行数: 34行
- ✅ 列数: 11列
- ✅ 全33プリセット名が日本語で表示される
- ✅ 色データがa,r,g,b形式で記録されている

---

### テスト2: 変換スクリプトの実行

#### 目的
変換スクリプトが正常に動作し、C++ヘッダーファイルを生成できることを確認する。

#### 手順
```bash
cd /home/runner/work/Windy_Lines/Windy_Lines

# 1. Pythonのバージョン確認
python --version
# 期待値: Python 3.x

# 2. 変換スクリプトを実行
python color_preset_converter.py

# 実行結果の例:
# Reading color presets from: color_presets.tsv
# Parsed 33 color presets
# ✓ Generated: /path/to/SDK_ProcAmp_ColorPresets.h
# ✓ Total color presets: 33
# ✓ Total colors: 264
# 
# Preset Summary:
#   [1] レインボー (Rainbow)
#   [2] パステルレインボー (RainbowPastel)
#   ...
#   [33] モノクロ (Monochrome)
```

#### 期待される結果
- ✅ エラーなく実行完了
- ✅ SDK_ProcAmp_ColorPresets.h が生成される
- ✅ "✓ Generated" メッセージが表示される
- ✅ "Total color presets: 33" と表示される
- ✅ "Total colors: 264" と表示される
- ✅ 全33プリセットのサマリーが表示される

---

### テスト3: 生成されたヘッダーファイルの検証

#### 目的
生成されたC++ヘッダーファイルが正しい構造と内容を持っているか確認する。

#### 手順
```bash
cd /home/runner/work/Windy_Lines/Windy_Lines

# 1. ファイルが生成されたことを確認
ls -lh SDK_ProcAmp_ColorPresets.h

# 2. ファイルサイズを確認（約10-15KB程度）
du -h SDK_ProcAmp_ColorPresets.h

# 3. ファイルの先頭を確認（ヘッダーガード）
head -10 SDK_ProcAmp_ColorPresets.h
# 期待値:
# // Auto-generated by color_preset_converter.py - DO NOT EDIT MANUALLY
# // Edit color_presets.tsv and run color_preset_converter.py to regenerate
# 
# #ifndef SDK_PROCAMP_COLOR_PRESETS_H
# #define SDK_PROCAMP_COLOR_PRESETS_H
# ...

# 4. PresetColor構造体の定義を確認
grep -A 2 "struct PresetColor" SDK_ProcAmp_ColorPresets.h
# 期待値:
# struct PresetColor {
#     unsigned char a, r, g, b;
# };

# 5. namespace ColorPresets の存在を確認
grep "namespace ColorPresets" SDK_ProcAmp_ColorPresets.h

# 6. 全33プリセットが定義されているか確認
grep "const PresetColor k" SDK_ProcAmp_ColorPresets.h | wc -l
# 期待値: 33

# 7. GetPresetPalette関数の存在を確認
grep "GetPresetPalette" SDK_ProcAmp_ColorPresets.h

# 8. ファイルの末尾を確認（endif）
tail -5 SDK_ProcAmp_ColorPresets.h
# 期待値:
# ...
# #endif // SDK_PROCAMP_COLOR_PRESETS_H
```

#### 期待される結果
- ✅ ファイルサイズ: 約10-15KB
- ✅ ヘッダーガードが正しく定義されている
- ✅ PresetColor構造体が定義されている
- ✅ namespace ColorPresets が存在する
- ✅ 33個のプリセット配列が定義されている
- ✅ GetPresetPalette()関数が定義されている
- ✅ ファイル末尾にendifがある

---

### テスト4: 色データの正確性検証

#### 目的
生成されたヘッダーファイルの色データが、既存のSDK_ProcAmp.hと完全に一致することを確認する。

#### 手順
```bash
cd /home/runner/work/Windy_Lines/Windy_Lines

# 1. レインボープリセットの最初の色を確認（既存）
grep -A 2 "const PresetColor kRainbow" SDK_ProcAmp.h | head -3
# 期待値: {255, 255, 0, 0}, ...

# 2. レインボープリセットの最初の色を確認（新規）
grep -A 2 "const PresetColor kRainbow" SDK_ProcAmp_ColorPresets.h | head -3
# 期待値: {255, 255, 0, 0}, ... （既存と同じ）

# 3. モノクロプリセットの最後の色を確認（既存）
grep -B 1 -A 2 "const PresetColor kMonochrome" SDK_ProcAmp.h | grep "255, 0, 0, 0"
# 期待値: {255, 0, 0, 0}

# 4. モノクロプリセットの最後の色を確認（新規）
grep -B 1 -A 2 "const PresetColor kMonochrome" SDK_ProcAmp_ColorPresets.h | grep "255, 0, 0, 0"
# 期待値: {255, 0, 0, 0} （既存と同じ）
```

#### 詳細な比較スクリプト
```bash
# 各プリセットの色データを比較するスクリプト
cd /home/runner/work/Windy_Lines/Windy_Lines

# レインボー
echo "=== Rainbow ==="
echo "既存:"
grep -A 2 "const PresetColor kRainbow" SDK_ProcAmp.h | grep -o "{[^}]*}" | head -8
echo "新規:"
grep -A 2 "const PresetColor kRainbow" SDK_ProcAmp_ColorPresets.h | grep -o "{[^}]*}" | head -8

# パステル
echo "=== Pastel ==="
echo "既存:"
grep -A 2 "const PresetColor kPastel\[" SDK_ProcAmp.h | grep -o "{[^}]*}" | head -8
echo "新規:"
grep -A 2 "const PresetColor kRainbowPastel" SDK_ProcAmp_ColorPresets.h | grep -o "{[^}]*}" | head -8

# モノクロ
echo "=== Monochrome ==="
echo "既存:"
grep -A 2 "const PresetColor kMonochrome" SDK_ProcAmp.h | grep -o "{[^}]*}" | head -8
echo "新規:"
grep -A 2 "const PresetColor kMonochrome" SDK_ProcAmp_ColorPresets.h | grep -o "{[^}]*}" | head -8
```

#### 期待される結果
- ✅ 各プリセットの色データが既存と完全に一致
- ✅ ARGB値の順序が正しい（a, r, g, b）
- ✅ 各プリセットに8色ある
- ✅ 色の値が0-255の範囲内

---

### テスト5: TSVの編集可能性テスト

#### 目的
TSVファイルを編集して再生成できることを確認する（実際の運用をシミュレーション）。

#### 手順
```bash
cd /home/runner/work/Windy_Lines/Windy_Lines

# 1. TSVファイルのバックアップを作成
cp color_presets.tsv color_presets.tsv.backup

# 2. テスト用に色を少し変更（レインボーの最初の色を変更）
# 元: 255,255,0,0
# 変更: 255,254,0,0 （赤を少し減らす）
sed -i '2s/255,255,0,0/255,254,0,0/' color_presets.tsv

# 3. 変換スクリプトを再実行
python color_preset_converter.py

# 4. 変更が反映されているか確認
grep -A 2 "const PresetColor kRainbow" SDK_ProcAmp_ColorPresets.h | head -3
# 期待値: {255, 254, 0, 0}, ... （変更された値）

# 5. 元に戻す
mv color_presets.tsv.backup color_presets.tsv
python color_preset_converter.py
```

#### 期待される結果
- ✅ TSVファイルの編集が可能
- ✅ 再生成により変更が即座に反映される
- ✅ エラーなく再生成できる

---

## ✅ テスト完了チェックリスト

以下の全項目が✅になったら、ステップ0完了です。

### TSVファイル
- [ ] color_presets.tsv が存在する
- [ ] ファイルサイズが約2-3KB
- [ ] 34行（ヘッダー + 33プリセット）
- [ ] 11列（id + name + name_en + color1-8）
- [ ] 全プリセット名が日本語で記録されている

### 変換スクリプト
- [ ] color_preset_converter.py が存在する
- [ ] エラーなく実行できる
- [ ] "Total color presets: 33" と表示される
- [ ] "Total colors: 264" と表示される

### 生成ヘッダー
- [ ] SDK_ProcAmp_ColorPresets.h が生成される
- [ ] ファイルサイズが約10-15KB
- [ ] ヘッダーガードが正しい
- [ ] PresetColor構造体が定義されている
- [ ] 33個のプリセット配列がある
- [ ] GetPresetPalette()関数が定義されている

### 色データの正確性
- [ ] レインボーの色が既存と一致
- [ ] モノクロの色が既存と一致
- [ ] 全プリセットの色データが既存と一致（サンプル確認）

### 既存コードへの影響
- [ ] SDK_ProcAmp.h は一切変更されていない
- [ ] 既存のビルドプロセスに影響なし
- [ ] 本番環境への影響ゼロ

---

## 🎯 テスト実行コマンドまとめ

以下のコマンドを順番に実行することで、すべてのテストを実施できます。

```bash
#!/bin/bash
# ステップ0 完全テストスクリプト

cd /home/runner/work/Windy_Lines/Windy_Lines

echo "=== テスト1: TSVファイルの検証 ==="
echo "ファイルサイズ:"
ls -lh color_presets.tsv

echo -e "\n行数（34であるべき）:"
wc -l color_presets.tsv

echo -e "\n列数（11であるべき）:"
head -1 color_presets.tsv | awk -F'\t' '{print NF}'

echo -e "\nヘッダー行:"
head -1 color_presets.tsv

echo -e "\n最初のプリセット（レインボー）:"
head -2 color_presets.tsv | tail -1 | cut -f1-3

echo -e "\n最後のプリセット（モノクロ）:"
tail -1 color_presets.tsv | cut -f1-3

echo -e "\n全プリセット数:"
tail -n +2 color_presets.tsv | wc -l

echo -e "\n=== テスト2: 変換スクリプトの実行 ==="
python color_preset_converter.py

echo -e "\n=== テスト3: 生成ヘッダーの検証 ==="
echo "生成ファイルの存在確認:"
ls -lh SDK_ProcAmp_ColorPresets.h

echo -e "\nヘッダーガード確認:"
head -5 SDK_ProcAmp_ColorPresets.h

echo -e "\nPresetColor構造体確認:"
grep -A 2 "struct PresetColor" SDK_ProcAmp_ColorPresets.h

echo -e "\nプリセット数確認:"
grep -c "const PresetColor k" SDK_ProcAmp_ColorPresets.h

echo -e "\nGetPresetPalette関数確認:"
grep -c "GetPresetPalette" SDK_ProcAmp_ColorPresets.h

echo -e "\n=== テスト4: 色データの確認 ==="
echo "レインボー（既存）:"
grep -A 1 "const PresetColor kRainbow\[8\]" SDK_ProcAmp.h | tail -1 | grep -o "{[^}]*}" | head -3

echo -e "\nレインボー（新規）:"
grep -A 1 "const PresetColor kRainbow\[8\]" SDK_ProcAmp_ColorPresets.h | tail -1 | grep -o "{[^}]*}" | head -3

echo -e "\nモノクロ（既存）:"
grep -A 1 "const PresetColor kMonochrome\[8\]" SDK_ProcAmp.h | tail -1 | grep -o "{[^}]*}" | head -3

echo -e "\nモノクロ（新規）:"
grep -A 1 "const PresetColor kMonochrome\[8\]" SDK_ProcAmp_ColorPresets.h | tail -1 | grep -o "{[^}]*}" | head -3

echo -e "\n=== テスト5: 既存コードへの影響確認 ==="
echo "SDK_ProcAmp.h の変更確認:"
git status SDK_ProcAmp.h

echo -e "\n=== すべてのテスト完了 ==="
echo "上記の結果を確認し、すべてが期待通りであればステップ0完了です。"
```

---

## 📊 テスト結果の記録

テスト実行後、以下の表に結果を記録してください。

| テスト項目 | 結果 | 備考 |
|-----------|------|------|
| TSVファイル作成 | ✅ / ❌ | |
| TSV行数（34行） | ✅ / ❌ | |
| TSV列数（11列） | ✅ / ❌ | |
| 変換スクリプト実行 | ✅ / ❌ | |
| ヘッダー生成 | ✅ / ❌ | |
| プリセット数（33個） | ✅ / ❌ | |
| 色数（264色） | ✅ / ❌ | |
| レインボー色一致 | ✅ / ❌ | |
| モノクロ色一致 | ✅ / ❌ | |
| 既存コード無変更 | ✅ / ❌ | |

---

## 🚨 トラブルシューティング

### エラー: "FileNotFoundError: color_presets.tsv"
**原因**: TSVファイルが見つからない  
**解決**: 正しいディレクトリで実行しているか確認

```bash
pwd  # /home/runner/work/Windy_Lines/Windy_Lines であるべき
ls color_presets.tsv  # ファイルが存在するか確認
```

### エラー: "ValueError: Invalid color format"
**原因**: TSVファイルの色データが不正  
**解決**: TSVファイルの形式を確認

```bash
# 色データのフォーマットを確認
head -2 color_presets.tsv | tail -1 | cut -f4-11
# 期待値: 255,255,0,0	255,255,128,0	... （a,r,g,b形式）
```

### エラー: "Expected 8 colors"
**原因**: プリセットに8色ない  
**解決**: TSVファイルで該当プリセットの列数を確認

```bash
# 各行の列数を確認
awk -F'\t' '{print NR, NF}' color_presets.tsv
# すべての行が11列（id + name + name_en + 8 colors）であるべき
```

### 警告: 色データが既存と一致しない
**原因**: TSVからの抽出ミス or タイプミス  
**解決**: 該当プリセットのTSVと既存コードを比較

```bash
# 既存コードから色を抽出
grep -A 2 "const PresetColor kRainbow" SDK_ProcAmp.h

# TSVから色を抽出
grep "^1" color_presets.tsv | cut -f4-11

# 比較して差異を確認
```

---

## ✅ ステップ0完了の確認

以下をすべて確認できたら、ステップ0は完了です：

1. ✅ color_presets.tsv が正しく作成されている
2. ✅ color_preset_converter.py が正常に動作する
3. ✅ SDK_ProcAmp_ColorPresets.h が生成される
4. ✅ 33プリセット × 8色 = 264色すべてが含まれている
5. ✅ 色データが既存のSDK_ProcAmp.hと完全に一致する
6. ✅ SDK_ProcAmp.h は一切変更されていない
7. ✅ 既存のビルドプロセスに影響なし

**次のステップ**: ステップ1（新ヘッダーの追加）へ進む

---

**作成日**: 2026-02-09  
**対象**: ステップ0実装とテスト  
**ステータス**: 実装完了・テスト準備完了
