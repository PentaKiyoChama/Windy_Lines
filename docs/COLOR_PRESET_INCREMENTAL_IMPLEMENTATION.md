# 段階的実装プラン - 本番環境への影響を最小化

## 概要

このドキュメントは、配色カラープリセットTSVシステムを**本番環境に影響を与えずに**段階的に実装する方法を説明します。

各ステップで検証を行い、問題があればすぐに戻せる安全な実装方法です。

---

## 🎯 段階的実装の原則

1. **1つずつ実装**: 一度に1つの変更のみを行う
2. **必ず検証**: 各ステップ後にビルド・動作確認
3. **すぐロールバック可能**: 問題があれば即座に元に戻せる
4. **既存機能を壊さない**: 常に既存の動作を維持

---

## 📋 段階的実装ステップ

### ステップ0: 準備（本番コードに影響なし）
**目的**: 実装に必要なファイルを準備（既存コードは触らない）

**作業内容**:
```bash
# 1. color_presets.tsv を作成（OST_WindyLines.h から全33プリセットを抽出）
# 2. color_preset_converter.py を作成（POCをベースに本実装）
```

**検証方法**:
```bash
# 変換スクリプトを実行してヘッダーを生成
python color_preset_converter.py

# 生成されたヘッダーを確認
cat OST_WindyLines_ColorPresets.h

# 内容が正しいか目視確認
# - 33個のプリセットすべてがあるか
# - 各プリセットに8色あるか
# - 色の値が既存と一致するか
```

**影響**: ❌ なし（既存コードは全く変更していない）

**ロールバック**: 不要（既存コードに触れていないため）

**次のステップへ進む条件**:
- ✅ OST_WindyLines_ColorPresets.h が正常に生成される
- ✅ 33プリセット × 8色 = 264色すべてが含まれている
- ✅ 色の値が既存のOST_WindyLines.hと完全に一致

---

### ステップ1: 新ヘッダーの追加（既存機能に影響なし）
**目的**: 新しいヘッダーをプロジェクトに追加（既存の定義は残したまま）

**作業内容**:
```cpp
// OST_WindyLines.h の編集（行537の直前に追加）

// ========== 新しい色プリセットシステム（テスト中）==========
#if 0  // まだ有効化しない（テストのみ）
#include "OST_WindyLines_ColorPresets.h"
#endif
// ========================================================

// 以下、既存の定義はそのまま残す
struct PresetColor {
    unsigned char a, r, g, b;
};
namespace ColorPresets {
    const PresetColor kRainbow[8] = { ... };  // 既存のまま
    // ...
}
```

**検証方法**:
```bash
# 1. ビルドが通るか確認
make clean && make

# 2. After Effectsで起動して動作確認
# - プラグインが正常にロードされるか
# - 色プリセットが正常に表示されるか
# - 全33プリセットを切り替えて色が正しいか

# 3. 既存プロジェクトを開いて動作確認
# - 既存の.aepファイルが正常に開けるか
# - 色が変わっていないか
```

**影響**: ❌ なし（`#if 0`で無効化しているため、既存の定義のみが使われる）

**ロールバック方法**:
```bash
# 追加した #if 0 ... #endif ブロックを削除
git checkout HEAD -- OST_WindyLines.h
```

**次のステップへ進む条件**:
- ✅ ビルドが成功
- ✅ After Effectsで正常に動作
- ✅ 全プリセットの色が正しい
- ✅ 既存プロジェクトが正常に動作

---

### ステップ2: 新旧両方が共存する状態でテスト
**目的**: 新しいヘッダーを有効化するが、既存の定義も残してダブルチェック

**作業内容**:
```cpp
// OST_WindyLines.h

// 新しい色プリセットシステム
#include "OST_WindyLines_ColorPresets.h"

// ========== 既存の定義（一時的に残す）==========
// 削除予定だが、まだ残しておく（念のため）
/*
struct PresetColor {
    unsigned char a, r, g, b;
};
namespace ColorPresets {
    const PresetColor kRainbow[8] = { ... };
    // ... 既存の定義をコメントアウト
}
*/
// ===============================================
```

**重要**: この段階では`PresetColor`構造体の定義が重複するため、以下のように修正：

```cpp
// OST_WindyLines.h

// 新しい色プリセットシステム
#include "OST_WindyLines_ColorPresets.h"
// ↑ この中に struct PresetColor と namespace ColorPresets が定義されている

// 既存の定義は完全にコメントアウト（または削除）
// struct PresetColor { ... };  // 削除
// namespace ColorPresets { ... };  // 削除
// inline const PresetColor* GetPresetPalette(...) { ... };  // 削除
```

**検証方法**:
```bash
# 1. ビルド
make clean && make

# 2. After Effectsで全プリセットを確認
# - 全33プリセットが表示されるか
# - 各プリセットの色が正しいか
# - UIが正常に動作するか

# 3. レンダリングテスト
# - いくつかのエフェクトをレンダリング
# - 出力画像を以前のバージョンと比較
# - ピクセル単位で一致するか確認

# 4. 既存プロジェクトテスト
# - 複数の既存.aepファイルを開く
# - すべて正常に動作するか確認
```

**影響**: ⚠️ 低（新しいヘッダーを使用するが、内容は既存と同じ）

**ロールバック方法**:
```bash
# オプションA: includeを無効化して既存定義を復活
git checkout HEAD~1 -- OST_WindyLines.h

# オプションB: 手動で修正
# #include "OST_WindyLines_ColorPresets.h" をコメントアウト
# 既存の定義のコメントを外す
```

**次のステップへ進む条件**:
- ✅ ビルドが成功
- ✅ 全プリセットの色が既存と完全に一致
- ✅ レンダリング出力が既存と一致（ピクセル完全一致）
- ✅ 既存プロジェクトが正常に動作
- ✅ メモリリーク等の問題がない

---

### ステップ3: 既存コードの完全削除（最終移行）
**目的**: 既存のハードコードを削除し、新システムに完全移行

**作業内容**:
```cpp
// OST_WindyLines.h

// 色プリセット定義（自動生成）
#include "OST_WindyLines_ColorPresets.h"

// 既存の211行を完全に削除
// （行537-748を削除）
```

**検証方法**:
```bash
# 1. ビルド
make clean && make

# 2. フルテスト
# - 全プリセットの動作確認
# - レンダリングテスト
# - 既存プロジェクトテスト
# - パフォーマンステスト

# 3. コードレビュー
# - 削除した部分に他の依存がないか確認
# - includeが正しいか確認
```

**影響**: ⚠️ 中（既存コードを削除するが、新システムで同等機能を提供）

**ロールバック方法**:
```bash
# ステップ2の状態に戻す
git checkout HEAD~1 -- OST_WindyLines.h

# または、最悪の場合は元のコミットに完全に戻す
git revert <commit_hash>
```

**次のステップへ進む条件**:
- ✅ すべてのテストがパス
- ✅ 既存機能が100%動作
- ✅ パフォーマンス劣化なし

---

### ステップ4: 本番運用開始
**目的**: 新システムで本番運用を開始

**作業内容**:
- Git hookの設定（オプション）
- CI/CDの設定（オプション）
- ドキュメントの更新

**検証方法**:
```bash
# TSVを編集して変換スクリプトを実行
vim color_presets.tsv  # 色を少し変更してテスト
python color_preset_converter.py
make clean && make

# 変更が反映されているか確認
```

---

## 🔄 各ステップでのロールバック戦略

| ステップ | ロールバック難易度 | ロールバック方法 |
|---------|------------------|-----------------|
| ステップ0 | ⭐（簡単） | ファイル削除のみ |
| ステップ1 | ⭐（簡単） | `git checkout HEAD -- OST_WindyLines.h` |
| ステップ2 | ⭐⭐（普通） | includeをコメントアウト |
| ステップ3 | ⭐⭐⭐（やや複雑） | `git revert` または前ステップに戻す |
| ステップ4 | ⭐⭐⭐⭐（複雑） | 全体を前バージョンに戻す |

---

## 🧪 各ステップでの推奨テスト項目

### 最低限のテスト（各ステップで必須）
- [ ] ビルドが成功する
- [ ] After Effectsでプラグインがロードされる
- [ ] 全33プリセットが表示される
- [ ] プリセットを切り替えて色が表示される

### 標準テスト（ステップ2以降）
- [ ] レインボープリセットの色を目視確認
- [ ] 簡単なエフェクトをレンダリング
- [ ] 既存プロジェクト（1-2個）を開いて確認

### フルテスト（ステップ3以降）
- [ ] 全33プリセットを1つずつ確認
- [ ] 複数のエフェクトをレンダリング
- [ ] 既存プロジェクト（5-10個）を開いて確認
- [ ] 出力画像を既存バージョンと比較（ピクセル単位）
- [ ] パフォーマンステスト（レンダリング時間測定）
- [ ] メモリリークチェック

---

## ⏱️ 各ステップの所要時間見積もり

| ステップ | 作業時間 | テスト時間 | 合計 |
|---------|---------|-----------|------|
| ステップ0 | 2-3時間 | 30分 | 3時間 |
| ステップ1 | 30分 | 1時間 | 1.5時間 |
| ステップ2 | 30分 | 2時間 | 2.5時間 |
| ステップ3 | 15分 | 2時間 | 2時間 |
| ステップ4 | 1時間 | 1時間 | 2時間 |
| **合計** | **5時間** | **6.5時間** | **11時間** |

注: これは慎重なアプローチの場合。各ステップで問題がなければ、もっと早く進められます。

---

## 📊 リスクマトリックス

| ステップ | 本番影響 | ロールバック難易度 | リスクレベル |
|---------|---------|-------------------|-------------|
| ステップ0 | なし | 非常に簡単 | ✅ 極めて低 |
| ステップ1 | なし | 非常に簡単 | ✅ 極めて低 |
| ステップ2 | 低 | 簡単 | ⚠️ 低 |
| ステップ3 | 中 | 普通 | ⚠️ 中 |
| ステップ4 | 中 | やや複雑 | ⚠️ 中 |

---

## 🎯 推奨アプローチ

### 開発環境での実装（推奨）
1. まず開発環境でステップ0-4を完了
2. 十分にテストしてから本番へ

### 本番環境への適用
- **オプションA（安全）**: 開発環境で完全にテストしてから、本番環境にマージ
- **オプションB（慎重）**: 各ステップごとにブランチを作成してマージ

### ブランチ戦略
```bash
# 各ステップ用のブランチを作成
git checkout -b color-preset-step0  # 準備
git checkout -b color-preset-step1  # ヘッダー追加
git checkout -b color-preset-step2  # 新システム有効化
git checkout -b color-preset-step3  # 既存コード削除
git checkout -b color-preset-step4  # 本番運用

# 各ステップで十分にテストしてから次のブランチへ
```

---

## ✅ チェックリスト

### ステップ0完了の確認
- [ ] color_presets.tsv 作成完了
- [ ] color_preset_converter.py 作成完了
- [ ] OST_WindyLines_ColorPresets.h 生成成功
- [ ] 33プリセット × 8色 = 264色を確認
- [ ] 既存のOST_WindyLines.hと色の値が一致

### ステップ1完了の確認
- [ ] OST_WindyLines.h に include 追加（無効化状態）
- [ ] ビルド成功
- [ ] After Effects起動成功
- [ ] 全プリセット表示確認

### ステップ2完了の確認
- [ ] include を有効化
- [ ] 既存定義を削除
- [ ] ビルド成功
- [ ] 全プリセット動作確認
- [ ] レンダリング出力一致確認
- [ ] 既存プロジェクト動作確認

### ステップ3完了の確認
- [ ] 既存コード完全削除
- [ ] ビルド成功
- [ ] フルテスト完了
- [ ] パフォーマンス確認

### ステップ4完了の確認
- [ ] 本番運用開始
- [ ] TSV編集動作確認
- [ ] ドキュメント更新完了

---

## 🚨 トラブルシューティング

### ビルドエラーが出る場合
```bash
# 前のステップに戻す
git checkout HEAD~1 -- OST_WindyLines.h

# エラーメッセージを確認
make clean && make 2>&1 | tee build_error.log

# エラーを修正してから再試行
```

### 色が正しく表示されない場合
```bash
# TSVファイルを確認
cat color_presets.tsv | grep "レインボー"

# ヘッダーを再生成
python color_preset_converter.py

# OST_WindyLines.h との差分を確認
diff OST_WindyLines.h.backup OST_WindyLines_ColorPresets.h
```

### 既存プロジェクトが開けない場合
```bash
# 即座にロールバック
git checkout HEAD~1 -- OST_WindyLines.h
make clean && make

# 問題を調査してから再試行
```

---

## 📞 サポート

各ステップで問題が発生した場合:
1. すぐにロールバック
2. エラーログを確認
3. このドキュメントのトラブルシューティングを参照
4. 必要に応じて前のステップに戻って再確認

---

**まとめ**: 
このプランに従えば、**本番環境に影響を与えることなく**、安全に段階的に実装できます。各ステップで十分に検証し、問題があればすぐにロールバック可能です。

**最終更新**: 2026-02-09
